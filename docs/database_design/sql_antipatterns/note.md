# 概要

## 本

- SQL アンチパターン

# はじめに

アンチパターンの種類

- データベースの論理設計のアンチパターン
- データベースの物理設計のアンチぱｔーん
- クエリのアンチパターン

# Part:1 ジェイウォーク(信号無視)

- 「多対多」の交差テーブルの作成をさけるため、カンマ区切りでひとつのカラムに複数の値を格納すること

## 1.1 目的: 複数の値を持つ属性を格納する

## 1.2 アンチパターン: カンマ区切りフォーマットのリストを格納する

- うまくいっているように見えるが、パフォーマンス上の問題やデータ整合性の問題が発生

## 1.2.1 特定アカウントに関連する製品の検索

- 等価性による比較ができず、文字列パターンマッチが必要
- パターンマッチは意図しないレコードとマッチする可能性があるのと、インデックスによるメリットを得られない

## 1.2.2 特定製品に関連するアカウントの検索

- すべてのレコードで文字列をスキャン必要があり、インデックスを利用できない

## 1.2.3 集約クエリの作成

- 集約クエリはカンマ区切りのために作られておらず、クエリ作成で小細工が必要

## 1.2.4 特定の製品に関連するアカウントの更新

- リストのソート順を維持できない

## 1.2.5 アカウント ID の妥当性検証

- データ型による制約がないため、想定外の値が混入し得る

## 1.2.6 区切り文字の選択

- 格納したい値にカンマが含まれる可能性が考えられる
- この場合、区切り文字として何を扱うのか検討しなければならない。しかも、完全に対策できない場合が多い

## 1.2.7 リストの長さの制限

- 最大文字数をどのように決めるべきか
- 最大文字数によって格納できるリスト数が変動してしまう

## 1.3 アンチパターンの見つけ方

- 以下のワードが出てくると要注意
  - 「このリストでサポートしなくてはならない最大のエントリ数は？」
    - カラムの最大文字数を決めようとしているとき
  - 「SQL で単語境界を一致させる方法をしってる？」
    - カラム内の文字列を正規表現で取得しようとしているとき
    - 取得しようとしている要素を別カラムなどに格納した方がいい兆候
  - 「リストのエントリに絶対使われない文字ってなんだっけ？」
    - 区切り文字を探しているとき
    - いかなる値もいつか使われる可能性があることを肝に銘じるべき

## 1.4 アンチパターンを用いてもよい場合

- クエリのパフォーマンス向上のため、データベース構造を非正規化することがある
- 基本は正規化

## 1.5 解決策: 交差テーブルを作成する

- テーブルが 2 つのテーブルを参照する外部キーを持つ => 交差(インターセクション: intersection)テーブルと呼ばれる
- N:N, 多対多

## 1.5.1 特定のアカウントに関連する製品の検索 / 特定の製品に関連するアカウントの検索

- INNER JOIN で検索可能
- インデックス利用可能

## 1.5.2 集約クエリの作成

- GROUP BY, COUNT などを使ったシンプルなクエリを実行可能

## 1.5.3 製品の連絡先の更新

## 1.5.4 アカウント ID の妥当性検証

- データ型による制約が可能

## 1.5.5 区切り文字の選択

- 区切り文字が不要

## 1.5.6 リストの長さの制限

## 1.5.7 交差テーブルの他のメリット

- 外部キーでインデックスを用いることでパフォーマンスが向上
- 各エンティティのカラムに属性を保持可能

# Part2: ナイーブツリー(素朴な木)
