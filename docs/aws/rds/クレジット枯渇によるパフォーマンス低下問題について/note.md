## 事象

- 大量レコードを持つ既存テーブルに対してマイグレーションを実行したところ、著しくパフォーマンスが低下してしまう問題が発生

## 原因

- RDS で t 系インスタンスを利用している場合、バーストバランス(Burst Balance)と呼ばれるクレジットをもとに IOPS を適度にバーストさせている
- バーストバランスは一定時間ごとに回復する
- 今回の場合だと、回復量を上回るペースでクレジットを消費したことでクレジットが枯渇してパフォーマンスが低下してしまった

## バーストバランスの確認方法

- CloudWatch のメトリクスから「Burst Balance」という項目で RDS のクレジットの詳細を確認可能

## 解決策

- 実施したこと
  - マイグレーション用のスクリプトの最適化により、無駄なクエリを発行させないように修正
  - クエリの実行速度を調整してクレジット消費を抑える
- 未確認事項
  - RDS のインスタンスタイプのアップグレード
    - t 系の中でも上位グレードだとクレジットの許容値が大きいかもしれない
    - m 系に変更すればバーストという概念がなくなり、常にパフォーマンスが出るようになるかもしれない

## 今後の対策

- 本番同等のテストデータを用意して開発環境で動作テストすること
- 動作テストの際に、CloudWatch のメトリクスから「Burst Balance」を確認すること
- RDS のインスタンスタイプの変更を検討すること
